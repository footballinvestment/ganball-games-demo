<!DOCTYPE html>
<html lang="hu">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üéæ GƒÅnFoottennis</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="container">
      <div class="header">
        <div class="mode-toggle">
          <button class="mode-btn active" data-mode="basic">Alap M√≥d</button>
          <button class="mode-btn" data-mode="partner">üíé Partner M√≥d</button>
        </div>
        <h1>üéæ GƒÅnFoottennis</h1>
        <p id="subtitle">Konfigur√°ci√≥ Gener√°tor - Alap M√≥d</p>

        <div style="margin-top: 20px">
          <button class="back-btn" onclick="window.location.href='index.html'">
            ‚Üê Vissza a Hubra
          </button>
        </div>
      </div>

      <div class="content">
        <div class="section">
          <div class="section-title">üéØ √ârint√©sek Sz√°ma</div>
          <div class="touch-count-selector">
            <div class="touch-count-btn" data-count="1">1 √ârint√©s</div>
            <div class="touch-count-btn active" data-count="2">2 √ârint√©s</div>
            <div class="touch-count-btn" data-count="3">3 √ârint√©s</div>
            <div class="touch-count-btn free-mode" data-count="free">
              <div>üé≤ Szabad V√°laszt√°s</div>
              <div
                style="font-size: 0.8em; opacity: 0.7"
                id="free-choice-label"
              >
                üíé Partner funkci√≥
              </div>
            </div>
          </div>

          <div class="touch-config" id="touch-config">
            <div class="touch-item-config">
              <div class="touch-label">1. √ârint√©s</div>
              <div class="radio-group">
                <div
                  class="radio-btn active"
                  data-touch="1"
                  data-mode="generated"
                >
                  Gener√°lt
                </div>
                <div class="radio-btn free" data-touch="1" data-mode="free">
                  Szabad üíé
                </div>
              </div>
            </div>
            <div class="touch-item-config" id="touch-2-config">
              <div class="touch-label">2. √ârint√©s</div>
              <div class="radio-group">
                <div
                  class="radio-btn active"
                  data-touch="2"
                  data-mode="generated"
                >
                  Gener√°lt
                </div>
                <div class="radio-btn free" data-touch="2" data-mode="free">
                  Szabad üíé
                </div>
              </div>
            </div>
            <div
              class="touch-item-config"
              id="touch-3-config"
              style="display: none"
            >
              <div class="touch-label">3. √ârint√©s</div>
              <div class="radio-group">
                <div
                  class="radio-btn active"
                  data-touch="3"
                  data-mode="generated"
                >
                  Gener√°lt
                </div>
                <div class="radio-btn free" data-touch="3" data-mode="free">
                  Szabad üíé
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="section">
          <div class="section-title">üåç Opcion√°lis Kult√∫r√°k</div>
          <div class="cultures-grid">
            <div class="culture-card active" data-culture="cuju">
              <div class="checkbox"></div>
              <div class="culture-title">üè∫ CuJu Technik√°k</div>
              <div class="culture-desc">4000 √©ves k√≠nai technik√°k</div>
            </div>
            <div class="culture-card active" data-culture="mezoamerikai">
              <div class="checkbox"></div>
              <div class="culture-title">üèõÔ∏è Mezoamerikai</div>
              <div class="culture-desc">Cs√≠p≈ë technik√°k</div>
            </div>
            <div class="culture-card" data-culture="dominantFoot">
              <div class="checkbox"></div>
              <div class="culture-title">ü¶∂ Domin√°ns Oldal M√≥d</div>
              <div class="culture-desc">
                Jobb/Bal helyett Domin√°ns/Gyeng√©bb oldal
              </div>
            </div>
          </div>
        </div>

        <div class="generate-section">
          <button class="generate-btn" onclick="generate()">
            üé≤ Gener√°l√°s
          </button>
        </div>

        <div class="results" id="results">
          <div class="results-header">
            <h2>‚ö° Gener√°lt Konfigur√°ci√≥</h2>
          </div>
          <div class="results-content" id="results-content"></div>
          <div class="stats-footer" id="stats"></div>
        </div>

        <!-- GAME RECORDING SECTION -->
        <div class="game-recording-section" id="game-recording-section">
          <!-- Match Type Selection -->
          <div class="game-step active" id="game-step-match-type">
            <div class="game-step-title">üéØ Match T√≠pus V√°laszt√°sa</div>
            <div class="match-type-selector">
              <div class="match-type-btn" data-points="3" data-time="60">
                <div class="match-points">3 PONT</div>
                <div class="match-time">1 perc</div>
              </div>
              <div class="match-type-btn" data-points="11" data-time="180">
                <div class="match-points">11 PONT</div>
                <div class="match-time">3 perc</div>
              </div>
              <div class="match-type-btn" data-points="21" data-time="300" id="game-match-21">
                <div class="match-points">21 PONT</div>
                <div class="match-time">5 perc</div>
                <div class="partner-only">üíé Partner M√≥d</div>
              </div>
            </div>
            <div style="text-align: center; margin-top: 20px;">
              <button class="btn btn-primary" onclick="initializeGameSession()" id="init-game-btn" disabled>
                üéÆ GAME IND√çT√ÅSA (3 Match sorozat)
              </button>
            </div>
          </div>
          
          <!-- Game Ready -->
          <div class="game-step hidden" id="game-step-ready">
            <div class="game-step-title">üèÅ Match Ind√≠t√°s</div>
            <div id="game-ready-content">
              <!-- Dynamic content will be loaded here -->
            </div>
          </div>
          
          <!-- Game In Progress -->
          <div class="game-step hidden" id="game-step-progress">
            <div class="game-step-title">‚ö° J√°t√©k Folyamatban</div>
            <div id="game-progress-content">
              <!-- Dynamic content will be loaded here -->
            </div>
          </div>
          
          <!-- Game Summary -->
          <div class="game-step hidden" id="game-step-summary">
            <div class="game-step-title">üèÜ J√°t√©k Befejezve</div>
            <div id="game-summary-content">
              <!-- Dynamic content will be loaded here -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // === KONFIGUR√ÅCI√ì ===
      let config = {
        mode: "basic",
        touchCount: 2,
        isFreeCount: false,
        touches: { 1: "generated", 2: "generated", 3: "generated" },
        cultures: { cuju: true, mezoamerikai: true, dominantFoot: false },
      };

      // === GAME STATE MANAGEMENT ===
      let gameState = {
        isActive: false,
        currentConfig: null,
        generatedResult: null,
        matchType: null,
        selectedPoints: 0,
        selectedTime: 0,
        currentStep: 'match-type',
        sessionData: {
          matches: [],
          totalMatches: 3,
          currentMatch: 0,
          startTime: null,
          endTime: null
        }
      };

      // === GENERATED RESULT STORAGE ===
      let GENERATED_RESULT = null;

      // === TECHNIK√ÅK ===
      const TECHNIQUES = {
        serve: {
          modern: [
            "Jobb + Bels≈ë",
            "Jobb + R√ºszt",
            "Jobb + K√ºls≈ë",
            "Jobb + Sarok",
            "Jobb + T√©rd",
            "Jobb + V√°ll",
            "Bal + Bels≈ë",
            "Bal + R√ºszt",
            "Bal + K√ºls≈ë",
            "Bal + Sarok",
            "Bal + T√©rd",
            "Bal + V√°ll",
          ],
          cuju: ["Mell (CuJu)", "H√°t (CuJu)"],
          mezoamerikai: ["Jobb + Cs√≠p≈ë", "Bal + Cs√≠p≈ë"],
          fejeles: [
            "Bal k√©z feldob√°s + Fejel√©s",
            "Jobb k√©z feldob√°s + Fejel√©s",
            "K√©t k√©z feldob√°s + Fejel√©s",
          ],
        },
        touch: {
          modern: [
            "Jobb + Bels≈ë",
            "Jobb + R√ºszt",
            "Jobb + K√ºls≈ë",
            "Jobb + Sarok",
            "Jobb + T√©rd",
            "Jobb + V√°ll",
            "Bal + Bels≈ë",
            "Bal + R√ºszt",
            "Bal + K√ºls≈ë",
            "Bal + Sarok",
            "Bal + T√©rd",
            "Bal + V√°ll",
          ],
          cuju: ["Mell (CuJu)", "H√°t (CuJu)"],
          mezoamerikai: ["Jobb + Cs√≠p≈ë", "Bal + Cs√≠p≈ë"],
          fejeles: ["Fejel√©s"],
        },
      };

      const CATEGORY_LABELS = {
        modern: "ü¶∂ Modern Futball",
        cuju: "üè∫ 4000 √©ves CuJu",
        mezoamerikai: "üèõÔ∏è Mezoamerikai",
        fejeles: "ü§ï Fejel√©si",
        dominantside: "ü¶∂ Domin√°ns/Gyeng√©bb Oldal",
      };

      // === INICIALIZ√ÅL√ÅS ===
      document.addEventListener("DOMContentLoaded", function () {
        initEventListeners();
        updateUIForMode();
        updateTouchConfig();
        updateSessionCount();
      });

      function initEventListeners() {
        // Mode v√°lt√°s
        document.querySelectorAll(".mode-btn").forEach((btn) => {
          btn.addEventListener("click", function () {
            document
              .querySelectorAll(".mode-btn")
              .forEach((b) => b.classList.remove("active"));
            this.classList.add("active");
            config.mode = this.dataset.mode;
            updateUIForMode();
          });
        });

        // √ârint√©sek sz√°ma
        document.querySelectorAll(".touch-count-btn").forEach((btn) => {
          btn.addEventListener("click", function () {
            if (this.dataset.count === "free" && config.mode === "basic")
              return;

            document
              .querySelectorAll(".touch-count-btn")
              .forEach((b) => b.classList.remove("active"));
            this.classList.add("active");

            const count = this.dataset.count;
            config.isFreeCount = count === "free";
            config.touchCount = config.isFreeCount ? 0 : parseInt(count);
            updateTouchConfig();
          });
        });

        // √ârint√©s m√≥dok
        document.addEventListener("click", function (e) {
          if (e.target.classList.contains("radio-btn")) {
            if (e.target.dataset.mode === "free" && config.mode === "basic")
              return;

            const touch = e.target.dataset.touch;
            const mode = e.target.dataset.mode;

            document
              .querySelectorAll(`[data-touch="${touch}"]`)
              .forEach((btn) => {
                btn.classList.remove("active");
              });
            e.target.classList.add("active");
            config.touches[touch] = mode;
          }
        });

        // Kult√∫r√°k
        document.querySelectorAll(".culture-card").forEach((card) => {
          card.addEventListener("click", function () {
            this.classList.toggle("active");
            const culture = this.dataset.culture;
            config.cultures[culture] = this.classList.contains("active");
            console.log(
              "Kult√∫ra friss√≠tve:",
              culture,
              config.cultures[culture]
            ); // Debug log
          });
        });
      }

      function updateUIForMode() {
        const isPartner = config.mode === "partner";
        const freeChoiceBtn = document.querySelector('[data-count="free"]');
        const freeRadioBtns = document.querySelectorAll(
          '.radio-btn[data-mode="free"]'
        );
        const freeChoiceLabel = document.getElementById("free-choice-label");
        const subtitle = document.getElementById("subtitle");

        if (isPartner) {
          if (subtitle)
            subtitle.textContent =
              "Teljes Konfigur√°ci√≥ - üíé Partner M√≥d (269,002 kombin√°ci√≥)";
          if (freeChoiceBtn) {
            freeChoiceBtn.style.opacity = "1";
            freeChoiceBtn.style.pointerEvents = "auto";
          }
          if (freeChoiceLabel) {
            freeChoiceLabel.textContent = "‚úÖ El√©rhet≈ë";
            freeChoiceLabel.style.color = "#28a745";
          }
          freeRadioBtns.forEach((btn) => {
            btn.style.opacity = "1";
            btn.style.pointerEvents = "auto";
          });
        } else {
          if (subtitle)
            subtitle.textContent = "Konfigur√°ci√≥ Gener√°tor - Alap M√≥d";
          if (freeChoiceBtn) {
            freeChoiceBtn.style.opacity = "0.5";
            freeChoiceBtn.style.pointerEvents = "none";
          }
          if (freeChoiceLabel) {
            freeChoiceLabel.textContent = "üíé Partner funkci√≥";
            freeChoiceLabel.style.color = "#6c757d";
          }
          freeRadioBtns.forEach((btn) => {
            btn.style.opacity = "0.5";
            btn.style.pointerEvents = "none";
          });

          if (config.isFreeCount) {
            config.isFreeCount = false;
            config.touchCount = 2;
            document
              .querySelectorAll(".touch-count-btn")
              .forEach((b) => b.classList.remove("active"));
            document.querySelector('[data-count="2"]').classList.add("active");
          }

          config.touches[1] = "generated";
          config.touches[2] = "generated";
          config.touches[3] = "generated";

          document
            .querySelectorAll('.radio-btn[data-mode="generated"]')
            .forEach((btn) => {
              btn.classList.add("active");
            });
        }
        updateTouchConfig();
      }

      function updateTouchConfig() {
        const configDiv = document.getElementById("touch-config");
        const touch2 = document.getElementById("touch-2-config");
        const touch3 = document.getElementById("touch-3-config");

        if (config.isFreeCount) {
          configDiv.classList.remove("show");
        } else {
          configDiv.classList.add("show");
          if (touch2)
            touch2.style.display = config.touchCount >= 2 ? "flex" : "none";
          if (touch3)
            touch3.style.display = config.touchCount >= 3 ? "flex" : "none";
        }
      }

      function updateSessionCount() {
        // Update session count for GƒÅnFoottennis
        let sessionCount = parseInt(
          localStorage.getItem("ganball-total-sessions") || "0"
        );
        let gameStats = JSON.parse(
          localStorage.getItem("ganball-game-stats") || "{}"
        );

        if (!gameStats["ganfoottennis"]) {
          gameStats["ganfoottennis"] = { sessions: 0, lastPlayed: null };
        }

        gameStats["ganfoottennis"].sessions++;
        gameStats["ganfoottennis"].lastPlayed = new Date().toISOString();
        sessionCount++;

        localStorage.setItem("ganball-total-sessions", sessionCount.toString());
        localStorage.setItem("ganball-game-stats", JSON.stringify(gameStats));
      }

      // === GENER√ÅL√ÅS ===
      function generate() {
        // Button state management
        const generateBtn = document.querySelector(".generate-btn");
        generateBtn.textContent = "üîÑ Gener√°l√°s...";
        generateBtn.disabled = true;
        
        console.log("Gener√°l√°s ind√≠tva, config:", config);
        const result = {
          serve: generateServe(),
          touches: config.isFreeCount ? null : generateTouches(),
        };
        
        // üîß JAV√çT√ÅS: Elmentj√ºk a gener√°lt eredm√©nyt
        GENERATED_RESULT = result;
        console.log("‚úÖ Gener√°lt eredm√©ny elmentve:", GENERATED_RESULT);
        
        displayResults(result);
        
        // Reset button state
        setTimeout(() => {
          generateBtn.textContent = "üé≤ Gener√°l√°s";
          generateBtn.disabled = false;
        }, 500);
      }

      function generateServe() {
        const availableTechniques = getAvailableTechniques("serve");
        const technique = getRandomTechnique(availableTechniques);
        return {
          technique: technique,
          category: getTechniqueCategory(technique, "serve"),
        };
      }

      function generateTouches() {
        const touches = [];
        for (let i = 1; i <= config.touchCount; i++) {
          if (config.touches[i] === "free") {
            touches.push({
              number: i,
              technique: null,
              category: "free",
              isFree: true,
            });
          } else {
            const availableTechniques = getAvailableTechniques("touch", i);
            const technique = getRandomTechnique(availableTechniques);
            touches.push({
              number: i,
              technique: technique,
              category: getTechniqueCategory(technique, "touch"),
              isFree: false,
            });
          }
        }
        return touches;
      }

      function getAvailableTechniques(type, touchNumber = null) {
        let techniques = [
          ...TECHNIQUES[type].modern,
          ...TECHNIQUES[type].fejeles,
        ];
        if (config.cultures.cuju) {
          techniques = [...techniques, ...TECHNIQUES[type].cuju];
        }
        if (config.cultures.mezoamerikai) {
          if (
            type === "serve" ||
            (touchNumber && touchNumber === config.touchCount)
          ) {
            techniques = [...techniques, ...TECHNIQUES[type].mezoamerikai];
          }
        }

        // √öJ R√âSZ: Ha domin√°ns oldal m√≥d akt√≠v, cser√©ld a technik√°kat
        if (config.cultures.dominantFoot) {
          console.log("Domin√°ns m√≥d akt√≠v, technik√°k adapt√°l√°sa"); // Debug log
          techniques = techniques.map((tech) => {
            return tech
              .replace(/Jobb \+/g, "Domin√°ns Oldal +")
              .replace(/Bal \+/g, "Gyeng√©bb Oldal +");
          });
        }

        return techniques;
      }

      function getRandomTechnique(techniques) {
        return techniques[Math.floor(Math.random() * techniques.length)];
      }

      function getTechniqueCategory(technique, type) {
        // üîß JAV√çT√ÅS: Ha domin√°ns m√≥d akt√≠v, alak√≠tsd vissza az eredeti n√©vre a keres√©shez
        let originalTechnique = technique;
        if (config.cultures.dominantFoot) {
          originalTechnique = technique
            .replace(/Domin√°ns Oldal \+/g, "Jobb +")
            .replace(/Gyeng√©bb Oldal \+/g, "Bal +");
          console.log("Kateg√≥ria keres√©s:", technique, "‚Üí", originalTechnique); // Debug log
        }

        // Keres√©s az eredeti/visszaalak√≠tott n√©vvel
        for (const [category, techniques] of Object.entries(TECHNIQUES[type])) {
          if (techniques.includes(originalTechnique)) {
            return category;
          }
        }
        console.warn(
          "Ismeretlen technika kateg√≥ria:",
          technique,
          originalTechnique
        ); // Debug log
        return "unknown";
      }

      function displayResults(result) {
        let html = "";

        html += `
                <div class="serve-result">
                    <div class="serve-title">üè∫ SZERVA</div>
                    <div class="technique-name">${result.serve.technique}</div>
                    <div class="badge badge-${result.serve.category}">
                        ${CATEGORY_LABELS[result.serve.category]}
                    </div>
                </div>
            `;

        if (config.isFreeCount) {
          html += `
                    <div class="divider">‚¨áÔ∏è Ut√°na ‚¨áÔ∏è</div>
                    <div class="touch-result">
                        <div class="touch-number">üé≤ Teljes Szabad J√°t√©k</div>
                        <div class="technique-name">A j√°t√©kos mindent eld√∂nt</div>
                        <div class="badge badge-free">üéØ Teljes Szabads√°g</div>
                    </div>
                `;
        } else if (result.touches) {
          html += `<div class="divider">‚¨áÔ∏è Ut√°na ‚¨áÔ∏è</div>`;
          result.touches.forEach((touch) => {
            if (touch.isFree) {
              html += `
                            <div class="touch-result">
                                <div class="touch-number">‚ö° ${touch.number}. √ârint√©s</div>
                                <div class="technique-name">J√°t√©kos d√∂nt</div>
                                <div class="badge badge-free">üéØ Szabad V√°laszt√°s</div>
                            </div>
                        `;
            } else {
              html += `
                            <div class="touch-result">
                                <div class="touch-number">‚ö° ${
                                  touch.number
                                }. √ârint√©s</div>
                                <div class="technique-name">${
                                  touch.technique
                                }</div>
                                <div class="badge badge-${touch.category}">
                                    ${CATEGORY_LABELS[touch.category]}
                                </div>
                            </div>
                        `;
            }
          });
        }

        // Add game launcher section
        html += `
            <div class="game-launcher">
                <div class="game-launcher-title">üéÆ J√°t√©k Ind√≠t√°sa</div>
                <div class="game-launcher-desc">Ind√≠ts j√°t√©kot ezzel a gener√°lt konfigur√°ci√≥val!</div>
                <button class="btn btn-game-start" onclick="startGameWithGeneratedConfig()">
                    üèÅ J√ÅT√âK IND√çT√ÅSA
                </button>
            </div>
        `;

        document.getElementById("results-content").innerHTML = html;

        const mode = config.isFreeCount
          ? "TELJES SZABAD J√ÅT√âK"
          : `${config.touchCount} √âRINT√âS`;
        const modeText =
          config.mode === "partner" ? "üíé Partner M√≥d" : "Alap M√≥d";
        document.getElementById("stats").innerHTML = `
                üéØ M√≥d: ${mode} | ${modeText} | üéæ GƒÅnFoottennis Gener√°tor
            `;

        const results = document.getElementById("results");
        results.style.display = "none";
        setTimeout(() => {
          results.style.display = "block";
          results.scrollIntoView({ behavior: "smooth" });
        }, 10);
      }

      // === GAME FUNCTIONS ===
      function startGameWithGeneratedConfig() {
        console.log("üéÆ J√°t√©k ind√≠t√°s - aktu√°lis GENERATED_RESULT:", GENERATED_RESULT);
        
        if (!GENERATED_RESULT) {
          alert("‚ùå Hiba: Nincs gener√°lt konfigur√°ci√≥! K√©rlek gener√°lj egyet el≈ëbb.");
          return;
        }

        gameState.currentConfig = {
          mode: config.mode,
          touchCount: config.touchCount,
          isFreeCount: config.isFreeCount,
          touches: { ...config.touches },
          cultures: { ...config.cultures }
        };
        
        gameState.generatedResult = GENERATED_RESULT;
        console.log("‚úÖ J√°t√©kba mentett eredm√©ny:", gameState.generatedResult);
        
        const gameSection = document.getElementById("game-recording-section");
        gameSection.classList.add("active");
        gameSection.scrollIntoView({ behavior: "smooth" });
        
        initializeMatchTypeSelection();
      }

      function initializeMatchTypeSelection() {
        const matchTypeBtns = document.querySelectorAll(".match-type-btn");
        const initBtn = document.getElementById("init-game-btn");
        
        // Clear previous selections
        matchTypeBtns.forEach(btn => btn.classList.remove("active"));
        initBtn.disabled = true;
        
        // Handle 21 point match availability based on mode
        const match21 = document.getElementById("game-match-21");
        if (config.mode === "basic") {
          match21.classList.add("disabled");
        } else {
          match21.classList.remove("disabled");
        }
        
        // Add event listeners for match type selection
        matchTypeBtns.forEach(btn => {
          btn.addEventListener("click", function() {
            if (this.classList.contains("disabled")) return;
            
            // Remove active class from all buttons
            matchTypeBtns.forEach(b => b.classList.remove("active"));
            
            // Add active class to clicked button
            this.classList.add("active");
            
            // Store selected match type
            gameState.selectedPoints = parseInt(this.dataset.points);
            gameState.selectedTime = parseInt(this.dataset.time);
            gameState.matchType = this.dataset.points + "_points";
            
            // Enable init button
            initBtn.disabled = false;
            
            // Update button text
            initBtn.textContent = `üéÆ GAME IND√çT√ÅSA (3 √ó ${gameState.selectedPoints} pontos match)`;
          });
        });
      }

      function initializeGameSession() {
        if (!gameState.selectedPoints) return;
        
        // Initialize session data
        gameState.sessionData = {
          matches: [],
          totalMatches: 3,
          currentMatch: 0,
          startTime: new Date().toISOString(),
          endTime: null,
          configuration: { ...gameState.currentConfig },
          generatedResult: { ...gameState.generatedResult },
          matchType: gameState.matchType,
          points: gameState.selectedPoints,
          timeLimit: gameState.selectedTime
        };
        
        gameState.isActive = true;
        
        // Move to ready step
        showGameStep("ready");
        
        // Load ready content
        loadGameReadyContent();
      }

      function showGameStep(stepName) {
        // Hide all steps
        const steps = document.querySelectorAll(".game-step");
        steps.forEach(step => {
          step.classList.remove("active");
          step.classList.add("hidden");
        });
        
        // Show target step
        const targetStep = document.getElementById(`game-step-${stepName}`);
        if (targetStep) {
          targetStep.classList.remove("hidden");
          targetStep.classList.add("active");
          targetStep.scrollIntoView({ behavior: "smooth" });
        }
        
        gameState.currentStep = stepName;
      }

      function loadGameReadyContent() {
        const content = document.getElementById("game-ready-content");
        const matchNum = gameState.sessionData.currentMatch + 1;
        
        content.innerHTML = `
          <div style="text-align: center;">
            <div style="font-size: 2em; margin-bottom: 20px;">
              üèÜ Match ${matchNum}/3
            </div>
            <div style="font-size: 1.3em; margin-bottom: 20px; color: #667eea;">
              ${gameState.selectedPoints} Pontos Match (${gameState.selectedTime} m√°sodperc)
            </div>
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
              <h4 style="margin-bottom: 15px; color: #495057;">üìã Konfigur√°ci√≥:</h4>
              <div style="text-align: left; color: #6c757d;">
                ‚Ä¢ M√≥d: ${gameState.currentConfig.mode === "partner" ? "üíé Partner M√≥d" : "Alap M√≥d"}<br>
                ‚Ä¢ √ârint√©sek: ${gameState.currentConfig.isFreeCount ? "üé≤ Szabad V√°laszt√°s" : gameState.currentConfig.touchCount + " √©rint√©s"}<br>
                ‚Ä¢ Kult√∫r√°k: ${Object.entries(gameState.currentConfig.cultures).filter(([k,v]) => v).map(([k,v]) => k).join(", ") || "Nincs"}
              </div>
            </div>
            <div style="margin-top: 30px;">
              <button class="btn btn-primary" onclick="startMatch()" style="font-size: 1.2em; padding: 16px 32px;">
                üèÅ Match ${matchNum} IND√çT√ÅSA
              </button>
            </div>
          </div>
        `;
      }

      function startMatch() {
        // Record match start
        const matchData = {
          matchNumber: gameState.sessionData.currentMatch + 1,
          startTime: new Date().toISOString(),
          endTime: null,
          result: null,
          points: gameState.selectedPoints,
          timeLimit: gameState.selectedTime
        };
        
        gameState.sessionData.matches.push(matchData);
        
        // Move to progress step
        showGameStep("progress");
        loadGameProgressContent();
        
        // Start timer
        startMatchTimer();
      }

      function loadGameProgressContent() {
        const content = document.getElementById("game-progress-content");
        const matchNum = gameState.sessionData.currentMatch + 1;
        
        content.innerHTML = `
          <div style="text-align: center;">
            <div style="font-size: 1.8em; margin-bottom: 20px;">
              ‚è±Ô∏è Match ${matchNum} Folyamatban
            </div>
            <div id="timer-display" style="font-size: 3em; font-weight: bold; color: #28a745; margin: 20px 0;">
              ${gameState.selectedTime}
            </div>
            <div style="background: #fff3cd; padding: 20px; border-radius: 8px; margin: 20px 0; border: 1px solid #ffeaa7;">
              <h4 style="color: #856404; margin-bottom: 15px;">üéØ HASZN√ÅLT Konfigur√°ci√≥ (Gener√°ltb√≥l):</h4>
              <div id="active-config" style="color: #856404;">
                <!-- Will be populated with current configuration -->
              </div>
            </div>
            <div style="margin-top: 30px;">
              <button class="btn btn-primary" onclick="finishMatch()" style="font-size: 1.1em; margin-right: 10px;">
                ‚úÖ Match Befejez√©se
              </button>
              <button class="btn" onclick="cancelMatch()" style="background: #dc3545; color: white;">
                ‚ùå Megszak√≠t√°s
              </button>
            </div>
          </div>
        `;
        
        // Load the active configuration display
        loadActiveConfigDisplay();
      }

      function loadActiveConfigDisplay() {
        const activeConfigDiv = document.getElementById("active-config");
        if (!activeConfigDiv) return;
        
        const savedResult = gameState.generatedResult;
        if (!savedResult) {
          activeConfigDiv.innerHTML = `<div style="color: #dc3545;">‚ùå Hiba: Nincs mentett konfigur√°ci√≥!</div>`;
          return;
        }
        
        console.log("‚úÖ Mentett eredm√©ny haszn√°lata:", savedResult);
        
        let html = `
          <div style="text-align: center;">
            <div style="font-size: 1.2em; font-weight: bold; margin-bottom: 15px;">
              üè∫ SZERVA: ${savedResult.serve.technique}
            </div>
        `;
        
        if (savedResult.touches && savedResult.touches.length > 0) {
          html += `<div style="margin-top: 15px;">`;
          savedResult.touches.forEach(touch => {
            html += `
              <div style="margin: 8px 0; padding: 8px; background: rgba(255,255,255,0.5); border-radius: 4px;">
                ‚ö° ${touch.number}. √ârint√©s: ${touch.isFree ? "üéØ Szabad V√°laszt√°s" : touch.technique}
              </div>
            `;
          });
          html += `</div>`;
        } else if (gameState.currentConfig.isFreeCount) {
          html += `
            <div style="margin-top: 15px; padding: 12px; background: rgba(255,255,255,0.5); border-radius: 4px;">
              üé≤ Teljes Szabad J√°t√©k
            </div>
          `;
        }
        
        html += `</div>`;
        activeConfigDiv.innerHTML = html;
      }


      let matchTimer;
      function startMatchTimer() {
        let timeLeft = gameState.selectedTime;
        const timerDisplay = document.getElementById("timer-display");
        
        matchTimer = setInterval(() => {
          timeLeft--;
          
          if (timerDisplay) {
            timerDisplay.textContent = timeLeft;
            
            // Change color as time runs out
            if (timeLeft <= 10) {
              timerDisplay.style.color = "#dc3545";
            } else if (timeLeft <= 30) {
              timerDisplay.style.color = "#ffc107";
            } else {
              timerDisplay.style.color = "#28a745";
            }
          }
          
          if (timeLeft <= 0) {
            clearInterval(matchTimer);
            finishMatch();
          }
        }, 1000);
      }

      function finishMatch() {
        if (matchTimer) {
          clearInterval(matchTimer);
        }
        
        // Record match end
        const currentMatch = gameState.sessionData.matches[gameState.sessionData.currentMatch];
        currentMatch.endTime = new Date().toISOString();
        currentMatch.result = "completed";
        
        gameState.sessionData.currentMatch++;
        
        // Check if session is complete
        if (gameState.sessionData.currentMatch >= gameState.sessionData.totalMatches) {
          // Session complete
          gameState.sessionData.endTime = new Date().toISOString();
          showGameStep("summary");
          loadGameSummaryContent();
        } else {
          // More matches to play
          showGameStep("ready");
          loadGameReadyContent();
        }
      }

      function cancelMatch() {
        if (matchTimer) {
          clearInterval(matchTimer);
        }
        
        // Mark current match as cancelled
        if (gameState.sessionData.matches.length > 0) {
          const currentMatch = gameState.sessionData.matches[gameState.sessionData.currentMatch];
          currentMatch.endTime = new Date().toISOString();
          currentMatch.result = "cancelled";
        }
        
        gameState.sessionData.endTime = new Date().toISOString();
        
        // Go to summary
        showGameStep("summary");
        loadGameSummaryContent();
      }

      function loadGameSummaryContent() {
        const content = document.getElementById("game-summary-content");
        const matches = gameState.sessionData.matches;
        const completedMatches = matches.filter(m => m.result === "completed").length;
        const totalTime = calculateTotalSessionTime();
        
        content.innerHTML = `
          <div style="text-align: center;">
            <div style="font-size: 2em; margin-bottom: 20px;">
              üèÜ J√°t√©k Befejezve!
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 30px 0;">
              <div style="background: #f8fff9; padding: 20px; border-radius: 8px; border: 1px solid #28a745;">
                <div style="font-size: 2em; color: #28a745; margin-bottom: 10px;">
                  ${completedMatches}/${gameState.sessionData.totalMatches}
                </div>
                <div style="color: #6c757d;">Befejezett Matchek</div>
              </div>
              
              <div style="background: #f8f9ff; padding: 20px; border-radius: 8px; border: 1px solid #667eea;">
                <div style="font-size: 2em; color: #667eea; margin-bottom: 10px;">
                  ${Math.round(totalTime / 60)}m
                </div>
                <div style="color: #6c757d;">√ñsszes Id≈ë</div>
              </div>
              
              <div style="background: #fff8e1; padding: 20px; border-radius: 8px; border: 1px solid #ffc107;">
                <div style="font-size: 2em; color: #ffc107; margin-bottom: 10px;">
                  ${gameState.selectedPoints}
                </div>
                <div style="color: #6c757d;">Pontos Matchek</div>
              </div>
            </div>
            
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
              <h4 style="margin-bottom: 15px; color: #495057;">üìä Match R√©szletek:</h4>
              ${matches.map((match, index) => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; margin: 5px 0; background: white; border-radius: 4px;">
                  <span>Match ${match.matchNumber}</span>
                  <span style="color: ${match.result === 'completed' ? '#28a745' : '#dc3545'};">
                    ${match.result === 'completed' ? '‚úÖ Befejezve' : '‚ùå Megszak√≠tva'}
                  </span>
                </div>
              `).join('')}
            </div>
            
            <div style="margin-top: 30px;">
              <button class="btn btn-primary" onclick="startNewGameSession()" style="font-size: 1.1em; margin-right: 10px;">
                üîÑ √öj J√°t√©k Ind√≠t√°sa
              </button>
              <button class="btn" onclick="backToGenerator()" style="background: #6c757d; color: white;">
                üè† Vissza a Gener√°torhoz
              </button>
            </div>
          </div>
        `;
      }

      function calculateTotalSessionTime() {
        if (!gameState.sessionData.startTime || !gameState.sessionData.endTime) return 0;
        
        const start = new Date(gameState.sessionData.startTime);
        const end = new Date(gameState.sessionData.endTime);
        return Math.round((end - start) / 1000); // seconds
      }

      function startNewGameSession() {
        // Reset game state
        gameState.isActive = false;
        gameState.sessionData = {
          matches: [],
          totalMatches: 3,
          currentMatch: 0,
          startTime: null,
          endTime: null
        };
        
        // Go back to match type selection
        showGameStep("match-type");
        initializeMatchTypeSelection();
      }

      function backToGenerator() {
        // Hide game section
        const gameSection = document.getElementById("game-recording-section");
        gameSection.classList.remove("active");
        
        // Reset game state
        gameState.isActive = false;
        gameState.currentConfig = null;
        gameState.generatedResult = null;
        GENERATED_RESULT = null;
        gameState.sessionData = {
          matches: [],
          totalMatches: 3,
          currentMatch: 0,
          startTime: null,
          endTime: null
        };
        
        // Scroll back to results
        const results = document.getElementById("results");
        if (results) {
          results.scrollIntoView({ behavior: "smooth" });
        }
      }
    </script>
  </body>
</html>
